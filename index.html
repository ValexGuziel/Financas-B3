<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Finance App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --border: #1e293b;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      font-family: Segoe UI, Roboto, Arial;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 70px;
    }

    header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .radar-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .radar-layout {
        grid-template-columns: 1fr;
      }
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
    }

    .card small {
      color: var(--muted);
    }

    .card strong {
      display: block;
      font-size: 20px;
      margin-top: 6px;
    }

    .news-item {
      border-left: 3px solid var(--primary);
      padding-left: 12px;
      margin-bottom: 15px;
      font-size: 13px;
    }

    .news-item strong {
      display: block;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .news-item p {
      margin: 0;
      color: var(--muted);
      line-height: 1.4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      text-align: left;
    }

    th,
    td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      margin-bottom: 10px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      background: var(--border);
      color: var(--text);
      transition: 0.2s;
    }

    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: #000;
      font-weight: bold;
      width: 100%;
    }

    .btn-danger {
      color: var(--danger);
      background: transparent;
      font-size: 16px;
      padding: 0;
    }

    .btn-add-fast {
      background: var(--success);
      color: #000;
      font-weight: bold;
      padding: 4px 8px;
      font-size: 12px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }

    .page-info {
      font-size: 14px;
      color: var(--muted);
    }

    .nav-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
    }

    .nav-item {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }

    .nav-item.active {
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item span {
      display: block;
      font-size: 18px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .positivo {
      color: var(--success);
    }

    .negativo {
      color: var(--danger);
    }

    .buy-popup {
      background: var(--bg);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--primary);
      margin-top: 5px;
    }

    /* Estilo para o GrÃ¡fico */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <header><strong>ðŸ“Š Finance App</strong></header>

  <div class="container">

    <section id="radar" class="page active">
      <div class="radar-layout">
        <div class="radar-main">
          <h2>Radar de Mercado</h2>
          <div class="grid grid-4">
            <div class="card"><small>DÃ³lar</small><strong id="dolar">--</strong></div>
            <div class="card"><small>SELIC</small><strong id="selic">--</strong></div>
            <div class="card"><small>IPCA</small><strong id="ipca">--</strong></div>
            <div class="card"><small>CDI</small><strong id="cdi">--</strong></div>
          </div>

          <h3 style="margin-top:24px">AÃ§Ãµes B3</h3>
          <input type="text" id="inputBuscaRadar" placeholder="ðŸ” Buscar ticker ou empresa..." onkeyup="filtrarRadar()">

          <div class="card">
            <table>
              <thead>
                <tr>
                  <th>AÃ§Ã£o</th>
                  <th>PreÃ§o</th>
                  <th style="text-align: right;">AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody id="acoes"></tbody>
            </table>
            <div class="pagination">
              <button onclick="changePage(-1)" id="btnPrev">Â« Anterior</button>
              <span class="page-info" id="pageInfo">PÃ¡gina 1</span>
              <button onclick="changePage(1)" id="btnNext">PrÃ³xima Â»</button>
            </div>
          </div>
        </div>
        <div class="radar-news">
          <h3>ðŸ’¡ Insights do Dia</h3>
          <div class="card" id="comentarios-container"></div>
        </div>
      </div>
    </section>

    <section id="carteira" class="page">
      <h2>Minha Carteira</h2>
      <div class="card">
        <div class="grid grid-4">
          <input id="cticker" placeholder="AÃ§Ã£o">
          <input id="cqt" type="number" placeholder="Qtd">
          <input id="cpreco" type="number" placeholder="PreÃ§o MÃ©dio">
          <button class="btn-primary" onclick="addAtivo()">Salvar</button>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <table>
          <thead>
            <tr>
              <th>AÃ§Ã£o</th>
              <th>Qtd</th>
              <th>MÃ©dia</th>
              <th>Atual</th>
              <th>Resultado</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="listaCarteira"></tbody>
        </table>
      </div>
    </section>

    <section id="gastos" class="page">
      <h2>Financeiro</h2>
      <div class="card">
        <input id="desc" placeholder="DescriÃ§Ã£o">
        <input id="valor" type="number" placeholder="Valor R$">
        <select id="tipo">
          <option value="ganho">Entrada</option>
          <option value="gasto">SaÃ­da</option>
        </select>
        <button class="btn-primary" onclick="addMov()">Adicionar</button>
      </div>
      <div class="grid grid-4" style="margin-top:16px">
        <div class="card"><small>Saldo em Conta</small><strong id="saldoTotal">R$ 0</strong></div>
      </div>
      <div class="card" style="margin-top:16px">
        <table>
          <thead>
            <tr>
              <th>DescriÃ§Ã£o</th>
              <th>Valor</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="listaFin"></tbody>
        </table>
      </div>
    </section>

    <section id="resumo" class="page">
      <h2>Resumo Consolidado</h2>
      <div class="grid grid-4">
        <div class="card"><small>PatrimÃ´nio em AÃ§Ãµes</small><strong id="resPatrimonio">R$ 0</strong></div>
        <div class="card"><small>Saldo em Conta</small><strong id="resSaldo">R$ 0</strong></div>
        <div class="card"><small>Lucro/PrejuÃ­zo AÃ§Ãµes</small><strong id="resResultado">R$ 0</strong></div>
        <div class="card"><small>Total Geral</small><strong id="resTotalGeral">R$ 0</strong></div>
      </div>

      <div class="card" style="margin-top:20px; text-align: center;">
        <small>DistribuiÃ§Ã£o de PatrimÃ´nio</small>
        <div class="chart-container">
          <canvas id="resumoChart"></canvas>
        </div>
      </div>
    </section>

  </div>

  <nav class="nav-bottom">
    <div class="nav-item active" onclick="show('radar',this)"><span>ðŸ“¡</span>Radar</div>
    <div class="nav-item" onclick="show('carteira',this)"><span>ðŸ’¼</span>Carteira</div>
    <div class="nav-item" onclick="show('gastos',this)"><span>ðŸ’¸</span>Financeiro</div>
    <div class="nav-item" onclick="show('resumo',this)"><span>ðŸ“Š</span>Resumo</div>
  </nav>

  <script>
    let allStocks = [];
    let filteredStocks = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let precosAcoes = {};
    let chartInstance = null;

    let carteira = JSON.parse(localStorage.getItem("carteira_data")) || [];
    let finData = JSON.parse(localStorage.getItem("fin_data")) || [];

    function show(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      if (id === 'resumo') renderResumo();
    }

    /* --- RESUMO E GRÃFICOS --- */
    function renderResumo() {
      // CÃ¡lculos Financeiros
      let saldoConta = finData.reduce((acc, m) => acc + (m.t === 'ganho' ? m.v : -m.v), 0);

      // CÃ¡lculos Carteira
      let valorInvestido = 0;
      let valorAtual = 0;
      carteira.forEach(a => {
        const atual = precosAcoes[a.t] || 0;
        valorInvestido += (a.p * a.q);
        valorAtual += (atual * a.q);
      });

      let lucroAcoes = valorAtual - valorInvestido;
      let totalGeral = saldoConta + valorAtual;

      // Atualizar DOM
      document.getElementById('resPatrimonio').textContent = `R$ ${valorAtual.toFixed(2)}`;
      document.getElementById('resSaldo').textContent = `R$ ${saldoConta.toFixed(2)}`;
      document.getElementById('resResultado').textContent = `R$ ${lucroAcoes.toFixed(2)}`;
      document.getElementById('resResultado').className = lucroAcoes >= 0 ? 'positivo' : 'negativo';
      document.getElementById('resTotalGeral').textContent = `R$ ${totalGeral.toFixed(2)}`;

      // Atualizar GrÃ¡fico
      const ctx = document.getElementById('resumoChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Saldo em Conta', 'AÃ§Ãµes'],
          datasets: [{
            data: [saldoConta, valorAtual],
            backgroundColor: ['#38bdf8', '#22c55e'],
            borderColor: '#020617',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          }
        }
      });
    }

    /* --- LÃ“GICA RADAR --- */
    function filtrarRadar() {
      const termo = document.getElementById('inputBuscaRadar').value.toUpperCase();
      filteredStocks = allStocks.filter(s => s.stock.includes(termo) || s.name.toUpperCase().includes(termo));
      currentPage = 1;
      renderRadar();
    }

    function changePage(step) {
      const totalPages = Math.ceil(filteredStocks.length / itemsPerPage);
      if (currentPage + step >= 1 && currentPage + step <= totalPages) {
        currentPage += step;
        renderRadar();
      }
    }

    function renderRadar() {
      const corpo = document.getElementById('acoes');
      corpo.innerHTML = "";
      const pageItems = filteredStocks.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

      pageItems.forEach(a => {
        corpo.innerHTML += `
          <tr>
            <td><strong>${a.stock}</strong><br><small style="color:var(--muted)">${a.name}</small></td>
            <td>R$ ${a.close.toFixed(2)}</td>
            <td style="text-align: right;"><button class="btn-add-fast" onclick="toggleQuickAdd('${a.stock}')">ï¼‹</button></td>
          </tr>
          <tr id="form-${a.stock}" style="display:none">
            <td colspan="3"><div class="buy-popup"><div class="grid" style="grid-template-columns: 1fr 1fr auto; gap: 8px;">
              <input type="number" id="q-${a.stock}" placeholder="Qtd">
              <input type="number" id="p-${a.stock}" value="${a.close}" step="0.01">
              <button class="btn-primary" style="width:auto" onclick="quickAdd('${a.stock}')">Add</button>
            </div></div></td>
          </tr>`;
      });

      const totalPages = Math.ceil(filteredStocks.length / itemsPerPage) || 1;
      document.getElementById('pageInfo').textContent = `PÃ¡g ${currentPage} / ${totalPages}`;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage === totalPages;
    }

    function toggleQuickAdd(t) {
      const r = document.getElementById(`form-${t}`);
      r.style.display = r.style.display === 'none' ? 'table-row' : 'none';
    }

    function quickAdd(t) {
      const q = document.getElementById(`q-${t}`).value;
      const p = document.getElementById(`p-${t}`).value;
      if (q > 0) {
        carteira.push({ t, q: +q, p: +p });
        saveCarteira();
        alert(t + " adicionado!");
        toggleQuickAdd(t);
      }
    }

    /* --- CARTEIRA E FINANÃ‡AS --- */
    function saveCarteira() { localStorage.setItem("carteira_data", JSON.stringify(carteira)); renderCarteira(); }
    function renderCarteira() {
      const lista = document.getElementById('listaCarteira');
      lista.innerHTML = "";
      carteira.forEach((a, i) => {
        const atual = precosAcoes[a.t] || 0;
        const res = atual ? (atual * a.q) - (a.p * a.q) : 0;
        lista.innerHTML += `<tr><td><strong>${a.t}</strong></td><td>${a.q}</td><td>R$ ${a.p.toFixed(2)}</td><td>R$ ${atual.toFixed(2)}</td><td class="${res >= 0 ? 'positivo' : 'negativo'}">R$ ${res.toFixed(2)}</td><td><button class="btn-danger" onclick="carteira.splice(${i},1);saveCarteira()">ðŸ—‘</button></td></tr>`;
      });
    }

    function addMov() {
      finData.push({ d: desc.value, v: +valor.value, t: tipo.value });
      localStorage.setItem("fin_data", JSON.stringify(finData));
      renderFin();
      desc.value = ""; valor.value = "";
    }

    function renderFin() {
      let total = 0;
      document.getElementById('listaFin').innerHTML = finData.map((m, i) => {
        total += m.t === 'ganho' ? m.v : -m.v;
        return `<tr><td>${m.d}</td><td class="${m.t === 'ganho' ? 'positivo' : 'negativo'}">R$ ${m.v.toFixed(2)}</td><td><button class="btn-danger" onclick="finData.splice(${i},1);renderFin()">ðŸ—‘</button></td></tr>`;
      }).join('');
      document.getElementById('saldoTotal').textContent = "R$ " + total.toFixed(2);
    }

    /* --- APIS --- */
    async function fetchData() {
      const rA = await fetch("https://brapi.dev/api/quote/list");
      const dA = await rA.json();
      allStocks = dA.stocks || [];
      filteredStocks = allStocks;
      allStocks.forEach(s => precosAcoes[s.stock] = s.close);
      renderRadar();
      renderCarteira();

      const indices = { dolar: 1, selic: 11, ipca: 433, cdi: 12 };
      let dadosBCB = {};
      for (let [k, v] of Object.entries(indices)) {
        const r = await fetch(`https://api.bcb.gov.br/dados/serie/bcdata.sgs.${v}/dados/ultimos/1?formato=json`);
        const d = await r.json();
        const val = k === 'dolar' ? "R$ " + (+d[0].valor).toFixed(2) : d[0].valor + "%";
        document.getElementById(k).textContent = val;
        dadosBCB[k] = val;
      }
      atualizarInsights(dadosBCB);
    }

    function atualizarInsights(dados) {
      const container = document.getElementById('comentarios-container');
      container.innerHTML = `
        <div class="news-item"><strong>CÃ¢mbio</strong><p>DÃ³lar em ${dados.dolar}. Impacto direto em empresas exportadoras.</p></div>
        <div class="news-item"><strong>Juros</strong><p>Selic em ${dados.selic}. Renda fixa mantendo prÃªmio real elevado.</p></div>
        <div class="news-item"><strong>InflaÃ§Ã£o</strong><p>IPCA em ${dados.ipca}. Foco em ativos que protegem o poder de compra.</p></div>
        <div class="news-item"><strong>Dica</strong><p>Use a aba Resumo para ver como sua carteira estÃ¡ distribuÃ­da hoje.</p></div>
      `;
    }

    fetchData();
    renderFin();
  </script>
</body>

</html>